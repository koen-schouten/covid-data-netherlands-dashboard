<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Covid19 data Nederland</title>
    <link rel="stylesheet" href="common/css/style.css">

    <!-- chart.js-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>

    <!-- development version of vue.js, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

    <!--TODO replace with production version of vue.js when done -->
    <!--<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>-->

    <script type="module">
        import { COVID19DataMunicipalityPerDay } from "./common/js/models/COVID19DataMunicipalityPerDay.js";
        import { SVGMapOfDutchMunicipalities } from "./common/js/models/SVGMapOfDutchMunicipalities.js";
        import  {componentToHex, rgbToHex, colorRange} from "./common/js/utils/colorRange.js";

        window.addEventListener('DOMContentLoaded', (event) => {

            console.log('DOM fully loaded and parsed');

            //let date = "2020-02-28";
            //
            let municipality = "GM0014";

            //COVID19DataMunicipalityPerDay.getDataByMunicipality(municipality, data => console.log(data));
            //COVID19DataMunicipalityPerDay.getDataByDate(date, (data) => {console.log(data)});
            //SVGMapOfDutchMunicipalities.getMap((svg)=> document.body.insertAdjacentHTML("afterbegin", svg))


            //First get the map
            let getMapPromise = new Promise((resolve, reject) => {
                SVGMapOfDutchMunicipalities.getMap((svg) => {
                    let mapContainerElement = document.getElementById("dutch_municipality_map");
                    mapContainerElement.insertAdjacentHTML("afterbegin", svg);
                    resolve()
                });
            //Then get the lastest date
            }).then(function(result){
                return new Promise((resolve, reject) => { 
                    COVID19DataMunicipalityPerDay.getLatestDate((date)=>{
                        resolve(date)
                    });
                });
            //Then get all the data by this date.
            }).then(function(date){
                return new Promise((resolve, reject) => { 
                    COVID19DataMunicipalityPerDay.getDataByDate(date, (data) => {        
                        resolve(data);
                    }); 
                });
            //Then color the map
            }).then(function(data){
                let mapContainerElement = document.getElementById("dutch_municipality_map");
                let svgElement = mapContainerElement.childNodes[0];

                let dataTotalReported = data.map(element => element["Total_reported"]);

                let maxValue = Math.max(...dataTotalReported);
                let minValue = Math.min(...dataTotalReported);

                let colorMap = colorRange({R:0, G:255, B:0}, {R:255, G:0, B:0}, minValue, maxValue, 10);


                Array.from(svgElement.getElementsByTagName("path")).forEach(childNode => {
                    let municipalityCode = childNode.getAttribute("data-municipality-code");


                    let dataItem = data.find(element => element["Municipality_code"] == municipalityCode);

                    if(dataItem){
                        childNode.setAttribute("fill", rgbToHex(colorMap(dataItem["Total_reported"])));
                        childNode.setAttribute("data-total-reported", dataItem["Total_reported"]);
                    }

                })


            });
        });

    </script>
</head>

<body>
    <div id="dutch_municipality_map">
    </div>

</body>

</html>